<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Web Map</title>
        <link rel="stylesheet" href="src/leaflet.css">
        <link rel="stylesheet" href="src/css/bootstrap.css">
        <script src="src/leaflet-src.js"></script>
        <script src="src/jquery-3.6.0.min.js"></script>
        <style>
            #mapdiv {
                height: 100vh;
            }
        </style>
    </head>
    <body>
        <div class="row">
            <div id="side-bar" class="col-md-3">
                <button id="button-locate" class="btn btn-primary col-12">Locate</button>
                <br>
                <button id="button-karura" class="btn btn-primary col-12">Zoom to Karura</button>
                <h4>Zoom Level: <span id="zoom-level"></span></h4>
                <h4>Map Center : <span id="map-center"></span></h4>
                <h4>Mouse Location: <span id="mouse-location"></span></h4>
            </div>
            <div id="mapdiv" class="col-md-9"></div>
        </div>
        


        <script>
            var basicmap;
            var lyrOSM;
            var mrkCurrentLocation;
            var popKarura;
            var ctrlZoom; //new zoom control
            var ctrlAttr; //new attribtuiton control
            var ctrlScale; // new scale bar

            $(document).ready(
                function(){
                    var basicmap = L.map('mapdiv', {center: [19.4, -99.2], zoom:13, zoomControl:false, attributionControl:false});
                    var lyrOSM = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
                    basicmap.addLayer(lyrOSM);

                    ctrlZoom = L.control.zoom({zoomInText:'In', zoomOutText:'Out', position:'bottomright'});
                    ctrlZoom.addTo(basicmap)

                    ctrlAttr = L.control.attribution({position:'bottomleft'}).addTo(basicmap);
                    ctrlAttr.addAttribution('OSM');
                    ctrlAttr.addAttribution('&copy;<a href="https://dulojc.io"> dulojcio</a>')

                    ctrlScale = L.control.scale({position:'bottomleft'}).addTo(basicmap)

                    // call the locator every 5 seconds
                    // setInterval(function () {
                    //     basicmap.locate();
                    // }, 5000)
                    // Using the leaflet popup 
                    popKarura = L.popup({maxWidth:200, keepInView:true});
                    popKarura.setLatLng([-1.240071, 36.827717]);
                    popKarura.setContent(
                        "<h2>Karura</h2><img src='img/karura.jpg', width='300px'>"
                    );

                    basicmap.on('click', function (e) {
                        // console.log(e)
                        // alert(e.latlng.toString());
                        if (e.originalEvent.shiftKey) {
                            alert(basicmap.getZoom())
                        }
                        else{
                            alert(e.latlng.toString())
                        }
                    });
                    // put a marker on right-click and add some coordinate and current time details on clicking the map
                    basicmap.on('contextmenu', function (e) {
                        var dtCurrentTime = new Date();
                        L.marker(e.latlng).addTo(basicmap).bindPopup(e.latlng.toString() + "<br>" + dtCurrentTime.toString());
                    });
                    // key press event 
                    basicmap.on('keypress', function (e) {
                        console.log(e);
                        if (e.originalEvent.key=="l") {
                            basicmap.locate();
                        }
                    });

                    basicmap.on('locationfound', function (e) {
                        console.log(e);
                        
                        // delete markers
                        if (mrkCurrentLocation) {
                            mrkCurrentLocation.remove();
                        }
                        mrkCurrentLocation = L.circle(e.latlng, {radius:e.accuracy/2}).addTo(basicmap); //size of circle reflects accuracy of locator
                        basicmap.setView(e.latlng, 14);
                    });

                    basicmap.on('locationerror', function (e) {
                        console.log(e);
                        alert('location not found');
                    });

                    basicmap.on('zoomend', function (e) {
                        $("#zoom-level").html(basicmap.getZoom())
                    });

                    basicmap.on('moveend', function (e) {
                        $("#map-center").html(LatLngToArrayString(basicmap.getCenter()))
                    });

                    basicmap.on('mousemove', function (e) {
                        $("#mouse-location").html(LatLngToArrayString(e.latlng))
                    });
                    $("#button-locate").click(
                        function () {
                            basicmap.locate()
                        }
                    );
                    $("#button-karura").click(
                        function () {
                            basicmap.setView([-1.240071, 36.827717], 17);
                            basicmap.openPopup(popKarura);
                        }
                    );
                });

                function LatLngToArrayString(ll) {
                    return "["+ll.lat.toFixed(5)+", "+ll.lng.toFixed(5)+"]"
                }
            
        </script>
        
    </body>
</html>